{{/*
 Config Format Version

 Whenever a breaking change is made to the semantics of this configuration file, the configuration version
 expected by the router will be incremented. When the controller tries to load a configuration file with
 an incompatible version, it will abort with a message prompting the operator to seek out the breaking changes
 documentation.*/}}
v: 3

identity:
  cert:                 "{{ .ZitiPKI }}/{{ .ZitiCtrlIntermediateName }}/certs/{{ .RouterName }}-client.cert"
  server_cert:          "{{ .ZitiPKI }}/{{ .ZitiCtrlIntermediateName }}/certs/{{ .RouterName }}-server.cert"
  key:                  "{{ .ZitiPKI }}/{{ .ZitiCtrlIntermediateName }}/keys/{{ .RouterName }}-server.key"
  ca:                   "{{ .ZitiPKI }}/{{ .ZitiCtrlIntermediateName }}/certs/{{ .RouterName }}-cas.cert"

ctrl:
  endpoint:             tls:{{ .ZitiCtrlHostname }}:{{ .ZitiFabCtrlPort }}

link:
{{- if .IsPrivate }}
#  listeners:
#    - binding:          transport
#      bind:             tls:0.0.0.0:10080
#      advertise:        tls:{{ .ZitiEdgeRouterHostname }}:10080
#      options:
#        outQueueSize:   16
{{- else }}
  listeners:
    - binding:          transport
      bind:             tls:0.0.0.0:10080
      advertise:        tls:{{ .ZitiEdgeRouterHostname }}:10080
      options:
        outQueueSize:   16
{{- end }}
  dialers:
    - binding: transport

listeners:
{{- if or .IsFabricRouter .IsPrivate }}
#  - binding: tunnel
#    options:
#      mode: host #tproxy|tun|host
{{- else }}
  - binding: tunnel
    options:
      mode: host #tproxy|tun|host
{{- end }}
{{- if .IsPrivate }}
#  - binding: transport
#    address: {{if .WssEnabled}}ws{{else}}tls{{end}}:0.0.0.0:{{if .WssEnabled}}3023{{else}}{{ .ZitiEdgeRouterPort }}{{end}}
#    options:
#      advertise: {{ .ZitiEdgeRouterHostname }}:{{if .WssEnabled}}3023{{else}}{{ .ZitiEdgeRouterPort }}{{end}}
#      connectTimeoutMs: 5000
#      getSessionTimeout: 60s
{{- else if .WssEnabled }}
  - binding: edge
    address: {{if .WssEnabled}}ws{{else}}tls{{end}}:0.0.0.0:{{if .WssEnabled}}3023{{else}}{{ .ZitiEdgeRouterPort }}{{end}}
    options:
      advertise: {{ .ZitiEdgeRouterHostname }}:{{if .WssEnabled}}3023{{else}}{{ .ZitiEdgeRouterPort }}{{end}}
      connectTimeoutMs: 5000
      getSessionTimeout: 60s
{{- else if .IsFabricRouter }}
  - binding: transport
    address: tls:0.0.0.0:{{ .ZitiEdgeRouterPort }}
    options:
      advertise: {{ .ZitiEdgeRouterHostname }}:{{ .ZitiEdgeRouterPort }}
      connectTimeoutMs: 5000
      getSessionTimeout: 60s
{{ end }}

{{- if or .IsPrivate .IsFabricRouter }}
#edge:
csr:
  country: US
  province: NC
  locality: Charlotte
  organization: NetFoundry
  organizationalUnit: Ziti
  sans:
    dns:
      - {{ .ZitiEdgeRouterHostname }}
      - localhost
    ip:
      - "127.0.0.1"
{{- else }}
edge:
  csr:
    country: US
    province: NC
    locality: Charlotte
    organization: NetFoundry
    organizationalUnit: Ziti
    sans:
      dns:
        - {{ .ZitiEdgeRouterHostname }}
        - localhost
      ip:
        - "127.0.0.1"
{{ end }}

{{- if .WssEnabled }}
transport:
  ws:
    writeTimeout: 10
    readTimeout: 5
    idleTimeout: 5
    pongTimeout: 60
    pingInterval: 54
    handshakeTimeout: 10
    readBufferSize: 4096
    writeBufferSize: 4096
    enableCompression: true
    server_cert: {{ .ZitiPKI }}/{{ .ZitiCtrlIntermediateName }}/certs/{{ .RouterName }}-router-server.cert
    key: {{ .ZitiPKI }}/{{ .ZitiCtrlIntermediateName }}/keys/{{ .RouterName }}-router-server.key
{{- else if or .IsPrivate .IsFabricRouter }}
#transport:
#  ws:
#    writeTimeout:      10
#    readTimeout:       5
#    idleTimeout:       5
#    pongTimeout:       60
#    pingInterval:      54
#    handshakeTimeout:  10
#    readBufferSize:    4096
#    writeBufferSize:   4096
#    enableCompression: true
#    server_cert:       {{ .ZitiPKI }}/{{ .ZitiCtrlIntermediateName }}/certs/{{ .RouterName }}-router-server.cert
#    key:               {{ .ZitiPKI }}/{{ .ZitiCtrlIntermediateName }}/keys/{{ .RouterName }}-router-server.key
{{- end }}

forwarder:
  latencyProbeInterval: 1000
  xgressDialQueueLength: 1000
  xgressDialWorkerCount: 128
  linkDialQueueLength: 1000
  linkDialWorkerCount: 10